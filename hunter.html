<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emoji Hunter üéØ</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Lalezar&family=Rubik+Bubbles&family=Baloo+Bhaijaan+2:wght@400;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #131842;
            --bg-card: #1a1f4e;
            --accent-hot: #ff2d75;
            --accent-gold: #ffd700;
            --accent-cyan: #00e5ff;
            --accent-lime: #76ff03;
            --accent-orange: #ff9100;
            --text-primary: #f0f0ff;
            --text-muted: #8888bb;
            --danger: #ff1744;
            --glass: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        html,
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Baloo Bhaijaan 2', 'Lalezar', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            touch-action: manipulation;
        }

        .screen {
            display: none;
            width: 100vw;
            height: 100vh;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .screen.active {
            display: flex;
        }

        /* ===== BACKGROUND ===== */
        .bg-pattern {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-pattern::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background:
                radial-gradient(ellipse at 20% 50%, rgba(255, 45, 117, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(0, 229, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 80%, rgba(118, 255, 3, 0.08) 0%, transparent 50%);
            animation: bgFloat 20s ease-in-out infinite;
        }

        @keyframes bgFloat {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg)
            }

            33% {
                transform: translate(-2%, 1%) rotate(1deg)
            }

            66% {
                transform: translate(1%, -1%) rotate(-1deg)
            }
        }

        /* ===== SETUP SCREEN ===== */
        #setupScreen {
            padding: 5vw;
            gap: 3vh;
        }

        .game-logo {
            font-family: 'Rubik Bubbles', cursive;
            font-size: clamp(2.5rem, 10vw, 5rem);
            text-align: center;
            line-height: 1.2;
            background: linear-gradient(135deg, var(--accent-hot), var(--accent-gold), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 30px rgba(255, 45, 117, 0.4));
            animation: logoGlow 3s ease-in-out infinite alternate;
        }

        @keyframes logoGlow {
            from {
                filter: drop-shadow(0 0 20px rgba(255, 45, 117, 0.3))
            }

            to {
                filter: drop-shadow(0 0 40px rgba(0, 229, 255, 0.4))
            }
        }

        .logo-emoji {
            font-size: clamp(3rem, 12vw, 6rem);
            display: block;
            text-align: center;
            animation: emojiPulse 2s ease-in-out infinite;
            -webkit-text-fill-color: initial;
        }

        @keyframes emojiPulse {

            0%,
            100% {
                transform: scale(1) rotate(-5deg)
            }

            50% {
                transform: scale(1.15) rotate(5deg)
            }
        }

        .setup-card {
            width: 90vw;
            max-width: 420px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 6vw;
            backdrop-filter: blur(20px);
        }

        .setup-card label {
            display: block;
            font-size: clamp(1rem, 4vw, 1.3rem);
            font-weight: 700;
            margin-bottom: 1.5vh;
            color: var(--accent-cyan);
        }

        .setup-card textarea {
            width: 100%;
            height: 22vh;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid var(--glass-border);
            border-radius: 16px;
            color: var(--text-primary);
            font-family: 'Baloo Bhaijaan 2', sans-serif;
            font-size: 16px;
            padding: 4vw;
            resize: none;
            outline: none;
            direction: rtl;
            line-height: 2;
            transition: border-color 0.3s;
        }

        .setup-card textarea::placeholder {
            color: var(--text-muted);
            opacity: 0.6;
        }

        .setup-card textarea:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.15);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 2.5vh 8vw;
            font-family: 'Baloo Bhaijaan 2', sans-serif;
            font-size: clamp(1.1rem, 4.5vw, 1.5rem);
            font-weight: 800;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
            border-radius: inherit;
            pointer-events: none;
        }

        .btn:active {
            transform: scale(0.94);
        }

        .btn-start {
            background: linear-gradient(135deg, var(--accent-hot), #ff6b35);
            color: #fff;
            box-shadow: 0 8px 30px rgba(255, 45, 117, 0.4);
            min-width: 200px;
        }

        .btn-start:active {
            box-shadow: 0 4px 15px rgba(255, 45, 117, 0.3);
        }

        .btn-home {
            background: linear-gradient(135deg, var(--accent-cyan), #0080ff);
            color: #fff;
            box-shadow: 0 8px 30px rgba(0, 229, 255, 0.3);
            min-width: 200px;
            margin-top: 2vh;
            text-decoration: none;
        }

        .btn-home:active {
            box-shadow: 0 4px 15px rgba(0, 229, 255, 0.2);
        }

        .error-msg {
            color: var(--danger);
            font-size: 0.9rem;
            min-height: 1.5em;
            text-align: center;
            margin-top: 1vh;
        }

        /* ===== TURN / STAGE INTRO SCREEN ===== */
        #turnIntro {
            gap: 2.5vh;
        }

        .turn-player-name {
            font-family: 'Rubik Bubbles', cursive;
            font-size: clamp(1.8rem, 8vw, 3.5rem);
            text-align: center;
            color: var(--accent-gold);
            text-shadow: 0 0 40px rgba(255, 215, 0, 0.4);
        }

        .turn-stage-badge {
            background: var(--glass);
            border: 2px solid var(--accent-cyan);
            border-radius: 20px;
            padding: 2vh 6vw;
            text-align: center;
        }

        .turn-stage-badge .stage-num {
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            font-weight: 800;
            color: var(--accent-cyan);
        }

        .turn-stage-badge .stage-desc {
            font-size: clamp(0.85rem, 3.5vw, 1.1rem);
            color: var(--text-muted);
            margin-top: 0.5vh;
        }

        /* Stage progress dots */
        .stage-progress {
            display: flex;
            gap: 3vw;
            align-items: center;
            justify-content: center;
            margin-top: 1vh;
        }

        .stage-dot {
            width: clamp(14px, 4vw, 22px);
            height: clamp(14px, 4vw, 22px);
            border-radius: 50%;
            border: 2px solid var(--glass-border);
            background: transparent;
            transition: all 0.3s;
        }

        .stage-dot.done {
            background: var(--accent-lime);
            border-color: var(--accent-lime);
            box-shadow: 0 0 12px rgba(118, 255, 3, 0.5);
        }

        .stage-dot.current {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 12px rgba(0, 229, 255, 0.5);
            animation: dotPulse 1s ease-in-out infinite;
        }

        .stage-connector {
            width: clamp(20px, 6vw, 40px);
            height: 3px;
            background: var(--glass-border);
            border-radius: 2px;
        }

        .stage-connector.done {
            background: var(--accent-lime);
        }

        @keyframes dotPulse {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.3)
            }
        }

        .turn-total-score {
            font-size: clamp(0.9rem, 3.5vw, 1.2rem);
            color: var(--accent-orange);
            font-weight: 700;
            background: rgba(255, 145, 0, 0.1);
            border: 1px solid rgba(255, 145, 0, 0.3);
            border-radius: 14px;
            padding: 1vh 4vw;
        }

        .turn-countdown {
            font-size: clamp(4rem, 18vw, 8rem);
            font-family: 'Rubik Bubbles', cursive;
            color: var(--accent-hot);
            animation: countPulse 1s ease-in-out infinite;
        }

        @keyframes countPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1
            }

            50% {
                transform: scale(1.3);
                opacity: 0.7
            }
        }

        /* ===== GAME SCREEN ===== */
        #gameScreen {
            padding: 0;
        }

        .game-hud {
            width: 100vw;
            padding: 1.5vh 4vw;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--glass-border);
            z-index: 10;
            flex-shrink: 0;
        }

        .hud-player {
            font-size: clamp(0.75rem, 2.8vw, 0.95rem);
            font-weight: 700;
            color: var(--accent-gold);
            max-width: 22vw;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .hud-timer {
            font-family: 'Rubik Bubbles', cursive;
            font-size: clamp(1.8rem, 7vw, 3rem);
            color: var(--accent-cyan);
            min-width: 60px;
            text-align: center;
            transition: color 0.3s;
        }

        .hud-timer.danger {
            color: var(--danger);
            animation: timerShake 0.3s ease-in-out infinite;
        }

        @keyframes timerShake {

            0%,
            100% {
                transform: translateX(0)
            }

            25% {
                transform: translateX(-3px)
            }

            75% {
                transform: translateX(3px)
            }
        }

        .hud-score {
            font-size: clamp(1.1rem, 4.5vw, 1.6rem);
            font-weight: 800;
            color: var(--accent-lime);
        }

        /* Stage info bar */
        .stage-info-bar {
            width: 100vw;
            padding: 0.8vh 4vw;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2vw;
            background: rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
            z-index: 8;
        }

        .stage-info-badge {
            font-size: clamp(0.7rem, 2.5vw, 0.85rem);
            font-weight: 700;
            padding: 0.3vh 3vw;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .stage-info-badge.s1 {
            background: rgba(118, 255, 3, 0.15);
            color: var(--accent-lime);
            border: 1px solid rgba(118, 255, 3, 0.3);
        }

        .stage-info-badge.s2 {
            background: rgba(255, 145, 0, 0.15);
            color: var(--accent-orange);
            border: 1px solid rgba(255, 145, 0, 0.3);
        }

        .stage-info-badge.s3 {
            background: rgba(255, 23, 68, 0.15);
            color: var(--danger);
            border: 1px solid rgba(255, 23, 68, 0.3);
        }

        .hud-mini-dots {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .hud-mini-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--glass-border);
        }

        .hud-mini-dot.done {
            background: var(--accent-lime);
        }

        .hud-mini-dot.active {
            background: var(--accent-cyan);
            animation: dotPulse 1s ease-in-out infinite;
        }

        .target-bar {
            width: 100vw;
            padding: 1.2vh 4vw;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3vw;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.4), transparent);
            flex-shrink: 0;
            z-index: 5;
        }

        .target-label {
            font-size: clamp(0.85rem, 3vw, 1rem);
            color: var(--text-muted);
        }

        .target-emoji {
            font-size: clamp(2.5rem, 10vw, 4rem);
            animation: targetBounce 1.5s ease-in-out infinite;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));
        }

        @keyframes targetBounce {

            0%,
            100% {
                transform: translateY(0) scale(1)
            }

            50% {
                transform: translateY(-8px) scale(1.08)
            }
        }

        .game-arena {
            flex: 1;
            width: 100vw;
            position: relative;
            overflow: hidden;
        }

        .danger-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 20;
            border: 0px solid transparent;
            transition: border-width 0.3s;
        }

        .danger-overlay.active {
            border: 4px solid var(--danger);
            animation: dangerPulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes dangerPulse {
            from {
                border-color: rgba(255, 23, 68, 0.3);
                box-shadow: inset 0 0 30px rgba(255, 23, 68, 0.1)
            }

            to {
                border-color: rgba(255, 23, 68, 0.9);
                box-shadow: inset 0 0 60px rgba(255, 23, 68, 0.25)
            }
        }

        .emoji-item {
            position: absolute;
            font-size: clamp(2rem, 9vw, 3.5rem);
            cursor: pointer;
            z-index: 5;
            transition: transform 0.1s;
            will-change: transform, left, top, opacity;
            line-height: 1;
            padding: 4px;
        }

        .emoji-item:active {
            transform: scale(0.8);
        }

        .emoji-item.blink {
            animation: emojiBlink 0.8s ease-in-out infinite;
        }

        @keyframes emojiBlink {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.15
            }
        }

        .score-pop {
            position: absolute;
            font-size: clamp(1.5rem, 6vw, 2rem);
            font-weight: 800;
            pointer-events: none;
            z-index: 30;
            animation: scorePop 0.8s ease-out forwards;
        }

        .score-pop.correct {
            color: var(--accent-lime);
        }

        .score-pop.wrong {
            color: var(--danger);
        }

        @keyframes scorePop {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 1
            }

            100% {
                transform: translateY(-80px) scale(1.2);
                opacity: 0
            }
        }

        /* ===== STAGE COMPLETE OVERLAY ===== */
        .stage-complete-overlay {
            position: absolute;
            inset: 0;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2vh;
            background: rgba(10, 14, 39, 0.92);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        .stage-complete-icon {
            font-size: clamp(3rem, 14vw, 6rem);
            animation: emojiPulse 1.5s ease-in-out infinite;
        }

        .stage-complete-text {
            font-family: 'Rubik Bubbles', cursive;
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            color: var(--accent-gold);
            text-align: center;
        }

        .stage-complete-score {
            font-size: clamp(1.1rem, 4vw, 1.5rem);
            color: var(--accent-lime);
            font-weight: 700;
        }

        .stage-complete-next {
            font-size: clamp(0.9rem, 3.5vw, 1.1rem);
            color: var(--text-muted);
            margin-top: 1vh;
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.4
            }
        }

        /* ===== LEADERBOARD ===== */
        #leaderboard {
            gap: 2vh;
            padding: 4vh 5vw;
            overflow-y: auto;
        }

        .lb-title {
            font-family: 'Rubik Bubbles', cursive;
            font-size: clamp(2rem, 8vw, 3.5rem);
            text-align: center;
            background: linear-gradient(135deg, var(--accent-gold), var(--accent-hot));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .lb-trophy {
            font-size: clamp(3rem, 14vw, 6rem);
            text-align: center;
            animation: trophyFloat 2s ease-in-out infinite;
            -webkit-text-fill-color: initial;
        }

        @keyframes trophyFloat {

            0%,
            100% {
                transform: translateY(0) rotate(-3deg)
            }

            50% {
                transform: translateY(-10px) rotate(3deg)
            }
        }

        .lb-list {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 1.5vh;
        }

        .lb-item {
            display: flex;
            align-items: center;
            gap: 4vw;
            padding: 2vh 5vw;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            animation: slideIn 0.5s ease-out backwards;
        }

        .lb-item:nth-child(1) {
            border-color: var(--accent-gold);
            background: rgba(255, 215, 0, 0.08);
            animation-delay: 0.1s
        }

        .lb-item:nth-child(2) {
            border-color: #c0c0c0;
            background: rgba(192, 192, 192, 0.05);
            animation-delay: 0.2s
        }

        .lb-item:nth-child(3) {
            border-color: #cd7f32;
            background: rgba(205, 127, 50, 0.05);
            animation-delay: 0.3s
        }

        @keyframes slideIn {
            from {
                transform: translateX(60px);
                opacity: 0
            }

            to {
                transform: translateX(0);
                opacity: 1
            }
        }

        .lb-rank {
            font-family: 'Rubik Bubbles', cursive;
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            min-width: 12vw;
            text-align: center;
        }

        .lb-name {
            flex: 1;
            font-size: clamp(1rem, 4vw, 1.3rem);
            font-weight: 700;
        }

        .lb-score {
            font-size: clamp(1.2rem, 5vw, 1.6rem);
            font-weight: 800;
            color: var(--accent-lime);
        }

        .lb-detail {
            font-size: clamp(0.65rem, 2.2vw, 0.8rem);
            color: var(--text-muted);
            margin-top: 2px;
        }

        .btn-restart {
            background: linear-gradient(135deg, var(--accent-cyan), #0080ff);
            color: #fff;
            box-shadow: 0 8px 30px rgba(0, 229, 255, 0.3);
            margin-top: 2vh;
        }

        /* ===== PARTICLES ===== */
        .particle-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 100;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            font-size: clamp(1.2rem, 4vw, 2rem);
            animation: particleFall linear forwards;
            will-change: transform;
        }

        @keyframes particleFall {
            0% {
                transform: translateY(-10vh) rotate(0deg) scale(0.5);
                opacity: 1
            }

            70% {
                opacity: 1
            }

            100% {
                transform: translateY(110vh) rotate(720deg) scale(1.2);
                opacity: 0
            }
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            backdrop-filter: blur(6px);
            animation: fadeIn 0.25s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        .modal-box {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 5vh 6vw;
            max-width: 85vw;
            text-align: center;
        }

        .modal-box p {
            font-size: clamp(1rem, 4vw, 1.2rem);
            margin-bottom: 3vh;
            color: var(--text-primary);
            line-height: 1.8;
        }

        .modal-box .btn {
            padding: 1.5vh 6vw;
            font-size: clamp(0.9rem, 3.5vw, 1.1rem);
        }

        /* Dark mode */
        html:not(.dark) {
            --bg-primary: #0a0e27;
            --bg-secondary: #131842;
        }
    </style>
</head>

<body>

    <div class="bg-pattern"></div>

    <!-- ===== SETUP SCREEN ===== -->
    <div id="setupScreen" class="screen active">
        <div class="game-logo">
            <span class="logo-emoji">üéØ</span>
            Emoji Hunter
        </div>
        <div class="setup-card">
            <label>‚úçÔ∏è ÿ£ÿØÿÆŸÑ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑŸÑÿßÿπÿ®ŸäŸÜ (ŸÉŸÑ ÿßÿ≥ŸÖ ŸÅŸä ÿ≥ÿ∑ÿ±):</label>
            <textarea id="playerInput" placeholder="ÿ£ÿ≠ŸÖÿØ&#10;ÿ≥ÿßÿ±ÿ©&#10;ÿÆÿßŸÑÿØ&#10;ŸÜŸàÿ±"></textarea>
            <div id="errorMsg" class="error-msg"></div>
        </div>
        <button class="btn btn-start" id="btnStart">üöÄ ÿßÿ®ÿØÿ£ ÿßŸÑÿ®ÿ∑ŸàŸÑÿ©</button>
        <a href="index.html" class="btn btn-home">üè† ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</a>
    </div>

    <!-- ===== TURN / STAGE INTRO SCREEN ===== -->
    <div id="turnIntro" class="screen">
        <div id="turnPlayerName" class="turn-player-name"></div>
        <div class="stage-progress" id="stageProgress">
            <div class="stage-dot" id="dot1"></div>
            <div class="stage-connector" id="conn1"></div>
            <div class="stage-dot" id="dot2"></div>
            <div class="stage-connector" id="conn2"></div>
            <div class="stage-dot" id="dot3"></div>
        </div>
        <div class="turn-stage-badge">
            <div id="turnStageNum" class="stage-num"></div>
            <div id="turnStageDesc" class="stage-desc"></div>
        </div>
        <div id="turnTotalScore" class="turn-total-score" style="display:none"></div>
        <div id="turnCountdown" class="turn-countdown">3</div>
    </div>

    <!-- ===== GAME SCREEN ===== -->
    <div id="gameScreen" class="screen">
        <div class="game-hud">
            <div id="hudPlayer" class="hud-player"></div>
            <div id="hudTimer" class="hud-timer">20</div>
            <div id="hudScore" class="hud-score">0</div>
        </div>
        <div class="stage-info-bar">
            <div id="stageInfoBadge" class="stage-info-badge s1"></div>
            <div class="hud-mini-dots" id="hudMiniDots">
                <div class="hud-mini-dot" id="miniDot1"></div>
                <div class="hud-mini-dot" id="miniDot2"></div>
                <div class="hud-mini-dot" id="miniDot3"></div>
            </div>
        </div>
        <div class="target-bar">
            <span class="target-label">üéØ ÿßŸÑŸáÿØŸÅ:</span>
            <span id="targetEmoji" class="target-emoji"></span>
        </div>
        <div class="game-arena" id="gameArena">
            <div class="danger-overlay" id="dangerOverlay"></div>
        </div>
    </div>

    <!-- ===== LEADERBOARD ===== -->
    <div id="leaderboard" class="screen">
        <div class="lb-trophy">üèÜ</div>
        <div class="lb-title">ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿ™ÿµÿØÿ±ŸäŸÜ</div>
        <div class="lb-list" id="lbList"></div>
        <button class="btn btn-restart" id="btnRestart">üîÑ ÿßŸÑÿπÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ</button>
    </div>

    <!-- ===== CELEBRATION ===== -->
    <div class="particle-container" id="particleContainer"></div>

    <script>
        /* =============================================================
           Emoji Hunter ‚Äì Multiplayer Tournament (3 Stages Per Player)
           ============================================================= */

        // ‚îÄ‚îÄ Dark mode ‚îÄ‚îÄ
        (function () {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function (e) {
                document.documentElement.classList.toggle('dark', e.matches);
            });
        })();

        // ‚îÄ‚îÄ Audio Engine ‚îÄ‚îÄ
        var AudioEngine = (function () {
            var ctx = null;
            function getCtx() {
                if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
                if (ctx.state === 'suspended') ctx.resume();
                return ctx;
            }
            function playTone(freq, dur, type, vol, ramp) {
                try {
                    var c = getCtx();
                    var osc = c.createOscillator();
                    var gain = c.createGain();
                    osc.type = type || 'sine';
                    osc.frequency.setValueAtTime(freq, c.currentTime);
                    if (ramp) osc.frequency.linearRampToValueAtTime(ramp, c.currentTime + dur);
                    gain.gain.setValueAtTime(vol || 0.3, c.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, c.currentTime + dur);
                    osc.connect(gain); gain.connect(c.destination);
                    osc.start(c.currentTime); osc.stop(c.currentTime + dur);
                } catch (e) { /* silent */ }
            }
            function playNoise(dur, vol) {
                try {
                    var c = getCtx();
                    var sz = c.sampleRate * dur;
                    var buf = c.createBuffer(1, sz, c.sampleRate);
                    var d = buf.getChannelData(0);
                    for (var i = 0; i < sz; i++) d[i] = (Math.random() * 2 - 1) * 0.5;
                    var src = c.createBufferSource(); src.buffer = buf;
                    var gain = c.createGain();
                    gain.gain.setValueAtTime(vol || 0.15, c.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, c.currentTime + dur);
                    var flt = c.createBiquadFilter(); flt.type = 'highpass';
                    flt.frequency.setValueAtTime(3000, c.currentTime);
                    src.connect(flt); flt.connect(gain); gain.connect(c.destination); src.start();
                } catch (e) { /* silent */ }
            }
            return {
                correct: function () {
                    playTone(523, 0.12, 'sine', 0.25);
                    setTimeout(function () { playTone(659, 0.12, 'sine', 0.25); }, 80);
                    setTimeout(function () { playTone(784, 0.18, 'sine', 0.3); }, 160);
                },
                wrong: function () {
                    playTone(200, 0.25, 'sawtooth', 0.15);
                    playNoise(0.12, 0.1);
                },
                timeUp: function () {
                    playTone(440, 0.15, 'square', 0.2);
                    setTimeout(function () { playTone(349, 0.15, 'square', 0.2); }, 150);
                    setTimeout(function () { playTone(262, 0.4, 'square', 0.25); }, 300);
                },
                stageUp: function () {
                    playTone(523, 0.15, 'triangle', 0.25);
                    setTimeout(function () { playTone(659, 0.15, 'triangle', 0.25); }, 120);
                    setTimeout(function () { playTone(784, 0.15, 'triangle', 0.25); }, 240);
                    setTimeout(function () { playTone(1047, 0.3, 'triangle', 0.3); }, 360);
                },
                victory: function () {
                    var notes = [523, 587, 659, 698, 784, 880, 988, 1047];
                    notes.forEach(function (n, i) {
                        setTimeout(function () { playTone(n, 0.22, 'sine', 0.2); }, i * 100);
                    });
                    setTimeout(function () {
                        playTone(1047, 0.6, 'sine', 0.3);
                        playTone(784, 0.6, 'sine', 0.2);
                        playTone(523, 0.6, 'sine', 0.15);
                    }, 850);
                },
                countdown: function () { playTone(880, 0.1, 'sine', 0.2); },
                go: function () { playTone(1047, 0.3, 'triangle', 0.3); }
            };
        })();

        // ‚îÄ‚îÄ Emoji pools ‚îÄ‚îÄ
        var EMOJI_SETS = [
            ['üçé', 'üçä', 'üçã', 'üçá', 'üçì', 'ü´ê', 'üçë', 'ü•ù', 'üçå', 'ü•≠', 'üçí', 'üçç'],
            ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üê∏'],
            ['‚öΩ', 'üèÄ', 'üéæ', 'üèê', 'üé±', 'üèà', '‚öæ', 'ü•é', 'üèì', 'üèí', 'ü•ä', 'üé≥'],
            ['üöó', 'üöï', 'üöå', 'üèéÔ∏è', 'üöë', 'üöí', 'üõª', 'üöú', '‚úàÔ∏è', 'üöÄ', 'üõ∏', 'üöÅ'],
            ['üíé', '‚≠ê', 'üî•', 'üíß', '‚ùÑÔ∏è', 'üåô', '‚òÄÔ∏è', 'üåà', '‚ö°', 'üçÄ', 'üéµ', 'üí´']
        ];

        var STAGE_TIME = 20;
        var STAGE_NAMES = ['', 'ÿ≥ŸáŸÑÿ© üü¢', 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© üü°', 'ÿµÿπÿ®ÿ© üî¥'];
        var STAGE_DESCS = ['', 'ÿßŸÑÿ±ŸÖŸàÿ≤ ÿ´ÿßÿ®ÿ™ÿ© ‚Äì ÿßÿ¨ŸÖÿπ ÿ®ÿ≥ÿ±ÿπÿ©!', 'ÿßŸÑÿ±ŸÖŸàÿ≤ ÿ™ÿ™ÿ≠ÿ±ŸÉ ‚Äì ÿ±ŸÉŸëÿ≤!', 'ÿ≥ÿ±ÿπÿ© ÿπÿßŸÑŸäÿ© + ÿßÿÆÿ™ŸÅÿßÿ° ‚Äì ÿßŸÑÿ£ÿµÿπÿ®!'];
        var STAGE_CLASSES = ['', 's1', 's2', 's3'];

        // ‚îÄ‚îÄ Game State ‚îÄ‚îÄ
        var G = {
            players: [],
            currentPlayerIndex: 0,
            currentStage: 1,           // 1, 2, or 3
            playerTotalScore: 0,       // accumulated across 3 stages
            stageScore: 0,             // score for current stage only
            stageScores: {},           // { playerName: { 1: x, 2: y, 3: z } }
            totalScores: {},           // { playerName: total }
            timeLeft: STAGE_TIME,
            targetEmoji: '',
            emojiPool: [],
            timerInterval: null,
            moveInterval: null,
            emojis: [],
            arenaRect: null,
            running: false
        };

        // ‚îÄ‚îÄ DOM ‚îÄ‚îÄ
        var $ = function (id) { return document.getElementById(id); };
        var $setupScreen = $('setupScreen');
        var $turnIntro = $('turnIntro');
        var $gameScreen = $('gameScreen');
        var $leaderboard = $('leaderboard');
        var $playerInput = $('playerInput');
        var $errorMsg = $('errorMsg');
        var $turnPlayerName = $('turnPlayerName');
        var $turnStageNum = $('turnStageNum');
        var $turnStageDesc = $('turnStageDesc');
        var $turnTotalScore = $('turnTotalScore');
        var $turnCountdown = $('turnCountdown');
        var $hudPlayer = $('hudPlayer');
        var $hudTimer = $('hudTimer');
        var $hudScore = $('hudScore');
        var $stageInfoBadge = $('stageInfoBadge');
        var $targetEmoji = $('targetEmoji');
        var $gameArena = $('gameArena');
        var $dangerOverlay = $('dangerOverlay');
        var $lbList = $('lbList');
        var $particleContainer = $('particleContainer');

        function showScreen(el) {
            var screens = document.querySelectorAll('.screen');
            for (var i = 0; i < screens.length; i++) screens[i].classList.remove('active');
            el.classList.add('active');
        }

        function showModal(message, btnText, onOk) {
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.innerHTML =
                '<div class="modal-box"><p>' + message + '</p>' +
                '<button class="btn btn-start" style="min-width:120px">' + (btnText || 'ÿ≠ÿ≥ŸÜÿßŸã') + '</button></div>';
            document.body.appendChild(overlay);
            overlay.querySelector('button').addEventListener('click', function () {
                overlay.remove();
                if (onOk) onOk();
            });
        }

        // Update stage progress dots on intro screen
        function updateStageDotsIntro(currentStage) {
            var dots = [$('dot1'), $('dot2'), $('dot3')];
            var conns = [$('conn1'), $('conn2')];
            for (var i = 0; i < 3; i++) {
                dots[i].className = 'stage-dot';
                if (i < currentStage - 1) dots[i].classList.add('done');
                else if (i === currentStage - 1) dots[i].classList.add('current');
            }
            for (var j = 0; j < 2; j++) {
                conns[j].className = 'stage-connector';
                if (j < currentStage - 1) conns[j].classList.add('done');
            }
        }

        // Update mini dots on HUD
        function updateMiniDots(currentStage) {
            var dots = [$('miniDot1'), $('miniDot2'), $('miniDot3')];
            for (var i = 0; i < 3; i++) {
                dots[i].className = 'hud-mini-dot';
                if (i < currentStage - 1) dots[i].classList.add('done');
                else if (i === currentStage - 1) dots[i].classList.add('active');
            }
        }

        // ‚îÄ‚îÄ START BUTTON ‚îÄ‚îÄ
        $('btnStart').addEventListener('click', function () {
            AudioEngine.correct();
            var raw = $playerInput.value.trim();
            if (!raw) { $errorMsg.textContent = '‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ŸÑÿßÿπÿ® Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ!'; return; }
            var names = raw.split('\n').map(function (s) { return s.trim(); }).filter(function (s) { return s.length > 0; });
            if (names.length < 1) { $errorMsg.textContent = '‚ö†Ô∏è ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ŸÑÿßÿπÿ® Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ!'; return; }
            if (names.length > 10) { $errorMsg.textContent = '‚ö†Ô∏è ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ 10 ŸÑÿßÿπÿ®ŸäŸÜ!'; return; }
            $errorMsg.textContent = '';

            G.players = names;
            G.totalScores = {};
            G.stageScores = {};
            for (var i = 0; i < names.length; i++) {
                G.totalScores[names[i]] = 0;
                G.stageScores[names[i]] = { 1: 0, 2: 0, 3: 0 };
            }
            G.currentPlayerIndex = 0;
            G.currentStage = 1;
            G.playerTotalScore = 0;
            showStageIntro();
        });

        // ‚îÄ‚îÄ STAGE INTRO (shows before each of the 3 stages) ‚îÄ‚îÄ
        function showStageIntro() {
            var player = G.players[G.currentPlayerIndex];
            var stage = G.currentStage;

            $turnPlayerName.textContent = 'üéÆ ' + player;
            $turnStageNum.textContent = 'ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ' + stage + ' ‚Äì ' + STAGE_NAMES[stage];
            $turnStageDesc.textContent = STAGE_DESCS[stage];

            updateStageDotsIntro(stage);

            if (stage > 1) {
                $turnTotalScore.style.display = 'block';
                $turnTotalScore.textContent = '‚≠ê ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ≠ÿßŸÑŸä: ' + G.playerTotalScore + ' ŸÜŸÇÿ∑ÿ©';
            } else {
                $turnTotalScore.style.display = 'none';
            }

            showScreen($turnIntro);

            var count = 3;
            $turnCountdown.textContent = count;
            AudioEngine.countdown();

            var introInterval = setInterval(function () {
                count--;
                if (count > 0) {
                    $turnCountdown.textContent = count;
                    AudioEngine.countdown();
                } else if (count === 0) {
                    $turnCountdown.textContent = 'üî•';
                    AudioEngine.go();
                } else {
                    clearInterval(introInterval);
                    startStage();
                }
            }, 800);
        }

        // ‚îÄ‚îÄ START A STAGE ‚îÄ‚îÄ
        function startStage() {
            var player = G.players[G.currentPlayerIndex];
            var stage = G.currentStage;

            G.timeLeft = STAGE_TIME;
            G.stageScore = 0;
            G.running = true;

            // Pick emoji set (different for each stage of each player)
            var setIdx = (G.currentPlayerIndex * 3 + stage - 1) % EMOJI_SETS.length;
            G.emojiPool = EMOJI_SETS[setIdx];
            G.targetEmoji = G.emojiPool[Math.floor(Math.random() * G.emojiPool.length)];

            $hudPlayer.textContent = player;
            $hudTimer.textContent = String(STAGE_TIME);
            $hudTimer.classList.remove('danger');
            $hudScore.textContent = G.playerTotalScore;
            $targetEmoji.textContent = G.targetEmoji;
            $dangerOverlay.classList.remove('active');

            // Stage badge
            $stageInfoBadge.className = 'stage-info-badge ' + STAGE_CLASSES[stage];
            $stageInfoBadge.textContent = 'ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ' + stage + ' ‚Äì ' + STAGE_NAMES[stage];
            updateMiniDots(stage);

            showScreen($gameScreen);

            requestAnimationFrame(function () {
                G.arenaRect = $gameArena.getBoundingClientRect();
                spawnEmojis();
                startTimer();
                if (stage >= 2) startMovement();
            });
        }

        // ‚îÄ‚îÄ SPAWN EMOJIS ‚îÄ‚îÄ
        function spawnEmojis() {
            var existing = $gameArena.querySelectorAll('.emoji-item');
            for (var i = 0; i < existing.length; i++) existing[i].remove();
            G.emojis = [];

            var rect = G.arenaRect;
            if (!rect) return;
            var stage = G.currentStage;
            var count = 14 + stage * 4;
            var targetCount = Math.max(4, Math.floor(count * 0.3));
            var emojiSize = Math.min(rect.width, rect.height) * 0.1;
            var pad = 10;

            for (var j = 0; j < count; j++) {
                var isTarget = j < targetCount;
                var emoji = isTarget ? G.targetEmoji : getRandomDistractor();
                var el = document.createElement('div');
                el.className = 'emoji-item';
                el.textContent = emoji;
                el.dataset.isTarget = isTarget ? '1' : '0';

                var x = pad + Math.random() * (rect.width - emojiSize - pad * 2);
                var y = pad + Math.random() * (rect.height - emojiSize - pad * 2);
                el.style.left = x + 'px';
                el.style.top = y + 'px';

                if (stage === 3) {
                    el.classList.add('blink');
                    el.style.animationDelay = (Math.random() * 1.5) + 's';
                }

                var speed = 0;
                if (stage === 2) speed = 0.3 + Math.random() * 0.5;
                if (stage === 3) speed = 0.8 + Math.random() * 1.2;

                var data = { el: el, x: x, y: y, dx: (Math.random() - 0.5) * 2 * speed, dy: (Math.random() - 0.5) * 2 * speed };
                el.addEventListener('click', onEmojiClick);
                el.addEventListener('touchstart', function (e) { e.preventDefault(); }, { passive: false });
                $gameArena.appendChild(el);
                G.emojis.push(data);
            }
        }

        function getRandomDistractor() {
            var pool = G.emojiPool.filter(function (e) { return e !== G.targetEmoji; });
            return pool[Math.floor(Math.random() * pool.length)];
        }

        // ‚îÄ‚îÄ CLICK ‚îÄ‚îÄ
        function onEmojiClick(e) {
            if (!G.running) return;
            var el = e.currentTarget;
            var isTarget = el.dataset.isTarget === '1';
            var rect = el.getBoundingClientRect();
            var arenaRect = $gameArena.getBoundingClientRect();

            if (isTarget) {
                G.stageScore += 10;
                G.playerTotalScore += 10;
                AudioEngine.correct();
                showScorePop(rect.left - arenaRect.left, rect.top - arenaRect.top, '+10', true);
                el.remove();
                removeEmojiData(el);
                spawnSingleEmoji(true);
                spawnSingleEmoji(false);
            } else {
                var penalty = 5;
                G.stageScore = Math.max(0, G.stageScore - penalty);
                G.playerTotalScore = Math.max(0, G.playerTotalScore - penalty);
                AudioEngine.wrong();
                showScorePop(rect.left - arenaRect.left, rect.top - arenaRect.top, '-5', false);
                el.style.transform = 'scale(0.5)';
                setTimeout(function () { el.style.transform = ''; }, 200);
            }
            $hudScore.textContent = G.playerTotalScore;
        }

        function removeEmojiData(el) {
            G.emojis = G.emojis.filter(function (d) { return d.el !== el; });
        }

        function spawnSingleEmoji(isTarget) {
            var rect = G.arenaRect;
            if (!rect) return;
            var stage = G.currentStage;
            var emojiSize = rect.width * 0.1;
            var pad = 10;

            var emoji = isTarget ? G.targetEmoji : getRandomDistractor();
            var el = document.createElement('div');
            el.className = 'emoji-item';
            el.textContent = emoji;
            el.dataset.isTarget = isTarget ? '1' : '0';

            var x = pad + Math.random() * (rect.width - emojiSize - pad * 2);
            var y = pad + Math.random() * (rect.height - emojiSize - pad * 2);
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.style.opacity = '0';
            el.style.transition = 'opacity 0.3s';

            if (stage === 3) {
                el.classList.add('blink');
                el.style.animationDelay = (Math.random() * 1.5) + 's';
            }

            var speed = 0;
            if (stage === 2) speed = 0.3 + Math.random() * 0.5;
            if (stage === 3) speed = 0.8 + Math.random() * 1.2;

            var data = { el: el, x: x, y: y, dx: (Math.random() - 0.5) * 2 * speed, dy: (Math.random() - 0.5) * 2 * speed };
            el.addEventListener('click', onEmojiClick);
            el.addEventListener('touchstart', function (e) { e.preventDefault(); }, { passive: false });
            $gameArena.appendChild(el);
            G.emojis.push(data);
            requestAnimationFrame(function () { el.style.opacity = '1'; });
        }

        function showScorePop(x, y, text, isCorrect) {
            var pop = document.createElement('div');
            pop.className = 'score-pop ' + (isCorrect ? 'correct' : 'wrong');
            pop.textContent = text;
            pop.style.left = x + 'px';
            pop.style.top = y + 'px';
            $gameArena.appendChild(pop);
            setTimeout(function () { pop.remove(); }, 800);
        }

        // ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
        function startTimer() {
            G.timeLeft = STAGE_TIME;
            $hudTimer.textContent = String(STAGE_TIME);

            G.timerInterval = setInterval(function () {
                G.timeLeft--;
                $hudTimer.textContent = G.timeLeft;

                if (G.timeLeft <= 3 && G.timeLeft > 0) {
                    $hudTimer.classList.add('danger');
                    $dangerOverlay.classList.add('active');
                    AudioEngine.countdown();
                }
                if (G.timeLeft <= 0) {
                    endStage();
                }
            }, 1000);
        }

        // ‚îÄ‚îÄ MOVEMENT ‚îÄ‚îÄ
        function startMovement() {
            G.moveInterval = setInterval(function () {
                if (!G.running) return;
                var rect = G.arenaRect;
                if (!rect) return;
                var emojiSize = rect.width * 0.1;

                for (var i = 0; i < G.emojis.length; i++) {
                    var d = G.emojis[i];
                    d.x += d.dx; d.y += d.dy;
                    if (d.x < 0) { d.x = 0; d.dx *= -1; }
                    if (d.y < 0) { d.y = 0; d.dy *= -1; }
                    if (d.x > rect.width - emojiSize) { d.x = rect.width - emojiSize; d.dx *= -1; }
                    if (d.y > rect.height - emojiSize) { d.y = rect.height - emojiSize; d.dy *= -1; }
                    d.el.style.left = d.x + 'px';
                    d.el.style.top = d.y + 'px';
                }
            }, 16);
        }

        // ‚îÄ‚îÄ END STAGE ‚îÄ‚îÄ
        function endStage() {
            G.running = false;
            clearInterval(G.timerInterval);
            clearInterval(G.moveInterval);

            var player = G.players[G.currentPlayerIndex];
            var stage = G.currentStage;

            // Save stage score
            G.stageScores[player][stage] = G.stageScore;

            // Clear arena
            var items = $gameArena.querySelectorAll('.emoji-item');
            for (var i = 0; i < items.length; i++) items[i].remove();
            G.emojis = [];

            if (stage < 3) {
                // Show stage complete overlay INSIDE the game arena
                AudioEngine.stageUp();
                showStageCompleteOverlay(player, stage);
            } else {
                // All 3 stages done for this player
                AudioEngine.timeUp();
                G.totalScores[player] = G.playerTotalScore;
                G.currentPlayerIndex++;

                if (G.currentPlayerIndex < G.players.length) {
                    setTimeout(function () {
                        showModal(
                            'üèÅ ÿßŸÜÿ™Ÿáÿ™ ÿ¨ŸàŸÑÿ© <strong>' + player + '</strong>!<br>' +
                            'üìä ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä: <strong>' + G.playerTotalScore + '</strong> ŸÜŸÇÿ∑ÿ©<br><br>' +
                            '<span style="color:var(--accent-cyan)">ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© 1: ' + G.stageScores[player][1] + '</span> ¬∑ ' +
                            '<span style="color:var(--accent-orange)">ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© 2: ' + G.stageScores[player][2] + '</span> ¬∑ ' +
                            '<span style="color:var(--danger)">ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© 3: ' + G.stageScores[player][3] + '</span>',
                            '‚ñ∂Ô∏è ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑÿ™ÿßŸÑŸä',
                            function () {
                                G.currentStage = 1;
                                G.playerTotalScore = 0;
                                showStageIntro();
                            }
                        );
                    }, 400);
                } else {
                    // Tournament over!
                    G.totalScores[player] = G.playerTotalScore;
                    setTimeout(showLeaderboard, 600);
                }
            }
        }

        // ‚îÄ‚îÄ Stage Complete Overlay (transition between stages) ‚îÄ‚îÄ
        function showStageCompleteOverlay(player, completedStage) {
            var overlay = document.createElement('div');
            overlay.className = 'stage-complete-overlay';

            var icons = ['', '‚úÖ', 'üî•', ''];
            overlay.innerHTML =
                '<div class="stage-complete-icon">' + icons[completedStage] + '</div>' +
                '<div class="stage-complete-text">ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ' + completedStage + ' ÿßŸÉÿ™ŸÖŸÑÿ™!</div>' +
                '<div class="stage-complete-score">+' + G.stageScore + ' ŸÜŸÇÿ∑ÿ© ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©</div>' +
                '<div class="stage-complete-score" style="color:var(--accent-gold)">ÿßŸÑŸÖÿ¨ŸÖŸàÿπ: ' + G.playerTotalScore + ' ‚≠ê</div>' +
                '<div class="stage-complete-next">ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑŸÖÿ™ÿßÿ®ÿπÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ' + (completedStage + 1) + ' ‚ñ∂Ô∏è</div>';

            $gameArena.appendChild(overlay);

            function proceed() {
                overlay.remove();
                G.currentStage = completedStage + 1;
                showStageIntro();
            }

            overlay.addEventListener('click', proceed);
            overlay.addEventListener('touchstart', function (e) {
                e.preventDefault();
                proceed();
            }, { passive: false });
        }

        // ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ
        function showLeaderboard() {
            AudioEngine.victory();

            var sorted = G.players.slice().sort(function (a, b) {
                return G.totalScores[b] - G.totalScores[a];
            });

            var rankEmojis = ['ü•á', 'ü•à', 'ü•â'];
            $lbList.innerHTML = '';

            for (var i = 0; i < sorted.length; i++) {
                var name = sorted[i];
                var rank = i < 3 ? rankEmojis[i] : (i + 1);
                var ss = G.stageScores[name];
                var item = document.createElement('div');
                item.className = 'lb-item';
                item.style.animationDelay = (i * 0.12) + 's';
                item.innerHTML =
                    '<div class="lb-rank">' + rank + '</div>' +
                    '<div class="lb-name">' + name +
                    '<div class="lb-detail">üü¢ ' + ss[1] + ' ¬∑ üü° ' + ss[2] + ' ¬∑ üî¥ ' + ss[3] + '</div>' +
                    '</div>' +
                    '<div class="lb-score">' + G.totalScores[name] + ' ‚≠ê</div>';
                $lbList.appendChild(item);
            }

            showScreen($leaderboard);
            startCelebration();
        }

        // ‚îÄ‚îÄ CELEBRATION ‚îÄ‚îÄ
        function startCelebration() {
            $particleContainer.innerHTML = '';
            var emojis = ['‚ù§Ô∏è', 'üåπ', '‚ú®', 'üéâ', 'üíõ', 'üå∏', 'üéä', 'üíñ'];
            for (var i = 0; i < 50; i++) {
                (function (idx) {
                    setTimeout(function () {
                        var p = document.createElement('div');
                        p.className = 'particle';
                        p.textContent = emojis[idx % emojis.length];
                        p.style.left = (Math.random() * 100) + 'vw';
                        p.style.animationDuration = (2.5 + Math.random() * 3) + 's';
                        p.style.animationDelay = (Math.random() * 0.5) + 's';
                        p.style.fontSize = (1 + Math.random() * 1.5) + 'rem';
                        $particleContainer.appendChild(p);
                        setTimeout(function () { p.remove(); }, 6000);
                    }, idx * 80);
                })(i);
            }
        }

        // ‚îÄ‚îÄ RESTART ‚îÄ‚îÄ
        $('btnRestart').addEventListener('click', function () {
            AudioEngine.correct();
            $particleContainer.innerHTML = '';
            G.currentPlayerIndex = 0;
            G.currentStage = 1;
            G.playerTotalScore = 0;
            showScreen($setupScreen);
        });

        // ‚îÄ‚îÄ Prevent scroll during game ‚îÄ‚îÄ
        document.addEventListener('touchmove', function (e) {
            if (G.running) e.preventDefault();
        }, { passive: false });
    </script>
</body>

</html>